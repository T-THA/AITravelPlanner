# Task 3.2 测试指南 - AI 行程生成功能

## 测试概述

**测试目标**: 验证 AI 行程生成功能的完整性、准确性和性能
**测试范围**: 从需求提交到行程详情展示的完整流程
**验收标准**: 
- ✅ 生成时间 < 30 秒
- ✅ 成功率 > 95%
- ✅ 数据格式完全正确
- ✅ 用户体验流畅

---

## 📋 测试前准备

### 1. 环境检查

```bash
# 1. 确保开发服务器运行
cd frontend
npm run dev

# 2. 检查环境变量配置
# 确保 .env 文件包含:
VITE_DASHSCOPE_API_KEY=sk-xxx  # 阿里云百炼 API Key
VITE_SUPABASE_URL=https://xxx.supabase.co
VITE_SUPABASE_ANON_KEY=xxx

```

### 2. 数据库准备

- 确保 Supabase `trips` 表存在
- 确认 `itinerary` 字段为 JSONB 类型
- 用户已登录系统

### 3. 测试账号

- 邮箱: test@example.com
- 密码: Test123456

---

## 🧪 测试用例

### 测试用例 1: 北京 5 日文化游（标准场景）

**测试步骤**:

1. **导航到创建页面**
   - 点击侧边栏 "创建行程"
   - 或访问 `/itineraries/create`

2. **填写表单**（手动输入）
   ```

2. **填写表单**（手动输入）

   ```text
   目的地: 北京
   日期: 明天开始，5天（选择具体日期）
   预算: ¥8000
   人数: 2人
   人员构成: 成人
   旅行偏好: 文化、历史、美食
   住宿偏好: 舒适型
   行程节奏: 适中
   特殊需求: 希望包含故宫、长城、颐和园
   ```

3. **提交并观察**
   - 点击 "提交并生成行程" 按钮
   - 观察进度模态框出现
   - 记录以下时间点:
     * T1: 点击提交时间
     * T2: 进度模态框出现时间
     * T3: 行程生成完成时间（跳转到详情页）
     * **生成时长 = T3 - T1**

4. **验证详情页**
   - 检查标题: "北京5日游" 或类似
   - 检查行程概要是否合理
   - 检查亮点标签（3-5个）
   - 验证每日行程:
     * Day 1-5 是否都存在
     * 每天是否有主题
     * 每项是否包含: 时间、类型、标题、描述、位置、费用
   - 验证住宿推荐（4-5晚）
   - 验证交通方案（往返+当地）
   - 验证预算分配（6大类相加是否合理）

**预期结果**:

- ✅ 生成时间: 15-25 秒
- ✅ 行程包含故宫、长城、颐和园
- ✅ 每日 3-5 个行程项
- ✅ 预算分配总和接近 ¥8000（±20%）
- ✅ 无 JavaScript 错误

---

### 测试用例 2: 语音输入 + 生成（语音场景）

**测试步骤**:

1. **使用语音输入**
   - 点击 "语音输入" 按钮
   - 说话: "我想去杭州玩三天，预算5000元，喜欢自然风景和美食"
   - 等待识别完成
   - 查看表单自动填充情况

2. **补充信息**（如需要）
   - 选择具体日期
   - 确认人数和其他选项

3. **提交生成**
   - 观察生成流程
   - 记录时间

4. **验证结果**
   - 检查西湖是否在行程中
   - 检查是否包含美食推荐（餐厅类型行程项）
   - 预算分配是否合理

**预期结果**:

- ✅ 语音识别准确填充 80% 以上字段
- ✅ 生成时间 < 30 秒
- ✅ 行程符合用户偏好（自然+美食）

---

### 测试用例 3: 预算有限场景（边界测试）

**测试数据**:

```text
目的地: 成都
日期: 3天
预算: ¥2000（较低预算）
人数: 1人
偏好: 美食、休闲
```

**验证重点**:

- LLM 是否能在低预算下生成合理行程
- 住宿推荐是否符合预算（如青旅、经济型酒店）
- 景点是否侧重免费或低成本选项
- 预算分配是否在 ¥2000 ±20% 范围内

---

### 测试用例 4: 多目的地场景（复杂场景）

**测试数据**:

```text
目的地: 上海, 苏州, 杭州
日期: 7天
预算: ¥15000
人数: 4人（2成人+2儿童）
偏好: 亲子、文化、自然
```

**验证重点**:

- 是否覆盖所有 3 个城市
- 城市间交通安排是否合理
- 是否包含适合儿童的景点
- 每日行程是否考虑儿童体力

---

### 测试用例 5: 错误处理测试

**场景 A: 网络超时**

1. 提交表单时断开网络（模拟）
2. 观察错误提示
3. 验证需求是否仍保存为草稿

**场景 B: API 配额耗尽**

1. 故意使用无效 API Key
2. 提交表单
3. 观察错误提示
4. 验证用户能否返回列表页

**预期结果**:

- ✅ 友好的错误提示
- ✅ 需求已保存为草稿（status='draft'）
- ✅ 用户可重新尝试

---

## 📊 性能测试

### 生成时间统计（至少测试 10 次）

| 测试次数 | 目的地 | 天数 | 生成时长(秒) | 是否成功 | 备注 |
|---------|-------|------|-------------|---------|------|
| 1       | 北京   | 5    |             | ✅/❌   |      |
| 2       | 杭州   | 3    |             | ✅/❌   |      |
| 3       | 成都   | 4    |             | ✅/❌   |      |
| 4       | 西安   | 6    |             | ✅/❌   |      |
| 5       | 厦门   | 3    |             | ✅/❌   |      |
| 6       | 青岛   | 4    |             | ✅/❌   |      |
| 7       | 南京   | 3    |             | ✅/❌   |      |
| 8       | 重庆   | 5    |             | ✅/❌   |      |
| 9       | 昆明   | 6    |             | ✅/❌   |      |
| 10      | 三亚   | 5    |             | ✅/❌   |      |

**统计指标**:

- 平均生成时长: _____ 秒
- 成功率: _____ %
- 最快: _____ 秒
- 最慢: _____ 秒

**验收标准**:

- ✅ 平均时长 < 25 秒
- ✅ 成功率 > 95%

---

## 🔍 数据格式验证

### 打开浏览器控制台，检查生成的数据

```javascript
// 在详情页控制台执行
console.log(JSON.stringify(trip.itinerary, null, 2))
```

### 验证必需字段

**顶层字段**:

- ✅ `trip_title`: string
- ✅ `summary`: string
- ✅ `highlights`: string[] (3-5个)
- ✅ `daily_itinerary`: DailyItinerary[] (天数一致)
- ✅ `accommodation`: AccommodationPlan[]
- ✅ `transportation`: TransportationPlan
- ✅ `budget_breakdown`: BudgetBreakdown
- ✅ `tips`: string[]
- ✅ `emergency_contacts`: EmergencyContacts

**DailyItinerary 字段**:

- ✅ `day`: number
- ✅ `date`: string (YYYY-MM-DD)
- ✅ `theme`: string
- ✅ `items`: ItineraryItem[] (3-6个)

**ItineraryItem 字段**:

- ✅ `time`: string (HH:MM)
- ✅ `type`: 'attraction' | 'restaurant' | 'transport' | 'hotel' | 'other'
- ✅ `title`: string
- ✅ `description`: string
- ✅ `location`: string
- ✅ `cost`: number

---

## 🐛 常见问题排查

### 问题 1: 生成时间超过 30 秒

**可能原因**:

- 网络延迟
- LLM API 响应慢
- max_tokens 设置过大

**排查**:

```bash
# 检查网络延迟
curl -o /dev/null -s -w 'Time: %{time_total}s\n' https://dashscope.aliyuncs.com

# 查看控制台 Network 面板，确认 API 调用时间
```

### 问题 2: 生成失败率高

**可能原因**:

- API Key 配额不足
- Prompt 过于复杂导致解析失败
- JSON 提取逻辑错误

**排查**:

- 查看浏览器控制台 Console 错误
- 检查 Network 面板中 `/chat/completions` 请求
- 验证返回的 JSON 格式

### 问题 3: 数据格式不正确

**可能原因**:

- LLM 输出格式不一致
- JSON 解析逻辑问题

**修复**:

- 优化 Prompt 中的输出格式说明
- 增强 JSON 提取的容错能力

---

## ✅ 测试完成检查清单

### 功能完整性

- [ ] 表单提交成功保存到数据库
- [ ] 进度模态框正常显示和更新
- [ ] LLM 生成行程成功
- [ ] 行程保存到数据库（itinerary 字段）
- [ ] 状态更新为 'generated'
- [ ] 成功跳转到详情页

### 详情页展示

- [ ] 标题和概要正确显示
- [ ] 亮点标签正常
- [ ] 每日行程时间线完整
- [ ] 住宿推荐显示
- [ ] 交通方案显示
- [ ] 预算分配显示并计算正确

### 性能指标

- [ ] 生成时间 < 30 秒
- [ ] 成功率 > 95%（测试 10 次以上）

### 错误处理

- [ ] 网络错误有提示
- [ ] 生成失败保留草稿
- [ ] 用户可重新尝试

### 用户体验

- [ ] 加载动画流畅
- [ ] 进度提示清晰
- [ ] 错误提示友好
- [ ] 页面响应及时

---

## 📝 测试报告模板

```markdown
## Task 3.2 测试报告

**测试时间**: 2025-XX-XX
**测试人员**: XXX
**测试环境**: Chrome 120 / Windows 11

### 测试结果汇总

- 测试用例总数: 10
- 通过数量: X
- 失败数量: X
- 成功率: XX%
- 平均生成时长: XX 秒

### 发现的问题

1. [问题描述]
   - 严重程度: 高/中/低
   - 复现步骤: ...
   - 预期结果: ...
   - 实际结果: ...

### 优化建议

1. [建议内容]

### 结论

- [ ] 通过验收
- [ ] 需要修复后重新测试
```

---

**测试指南版本**: v1.0  
**创建日期**: 2025-01-03  
**适用版本**: Task 3.2
